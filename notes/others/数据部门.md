# 数据部门
## 常用网站
jeckens url:
http://192.168.0.66:8080/job/log服务项目/job/dby-datacenter-go/

### 部署流程

提交代码：

git add 

git commit -m 

arc diff

arc land

git tag v1.16.15

git push origin tag v1.16.15

Build jeckeins

/usr/local/k8s/config  修改文件

kubectl apply -f datacenter-go.yaml

查看版本号：https://data-center-dev.duobeiyun.com/_version



datacenter-go-version:
https://data-center-dev.duobeiyun.com/_version

kibana:
http://kibana.duobeiyun.com/app/kibana#/discover

grafana:
https://grafana.duobeiyun.net/d/c48RDROMz/datacenter-net-mongo-jian-kong?orgId=1


## 业务逻辑
https://vbqlkb723k.feishu.cn/docs/doccnT4XsK63z4LHuFj1CZaHn6b

### 查看mongo的连接数量



##  压测

QPS（Query Per Second）是用来衡量服务性能的一个重要指标，它的定义：对一个特定的查询服务器在规定时间内所处理流量的多少，计算公式：QPS = 并发量 / 平均响应时间。

通常 QPS 用来衡量服务器性能，不断的为增加它的数量而优化改进，通过多线程、增加负载、甚至提高代码质量、算法优化等方式。当然优化性能是有上限的，我们需要在性能和投入上作出一定的平衡。要对现有的业务状况、未来的发展潜力以及爆发力上作出一些判断，很好的驾驭它是需要花费一些精力的，需要经验和技术能力同时发挥作用，让效率和投入达到最好的产出。



使用wrc工具进行压测：

命令：`wrk -c 30 -t 10 -d 2s  --latency http://www.baidu.com`

![image-20210727101145837](https://i.loli.net/2021/07/27/wcgDUzXJOYrTZHk.png)

参数释义：

-t：需要模拟的线程数

-c：需要模拟的连接数

-d：测试的持续时间

----timeout 或 -T：超时的时间 

--latency：显示延迟统计

-s 或 --script:      lua脚本,使用方法往下看

-H, --header:      添加http header, 比如. "User-Agent: wrk"



### 测试Logan

wrk -c 100 -t 16 -d 1m -T 5s  -s aes.lua  --latency https://data-center-dev.duobeiyun.com/paas/collect-logan



![image-20210727103415951](https://i.loli.net/2021/07/27/JFVWEmwoGiSCtaX.png)

使用lua脚本：

```lua
wrk.method = "POST"
wrk.headers["Content-Type"] = "application/octet-stream"

file = io.open("/Users/yanzx/Files/yace/aes-windows.json", "rb")
wrk.body = file:read("*a")
```



 ### 测试 paas-event

wrk -c 250 -t 20 -d 1m -T 5s  -s event.lua  --latency https://data-center-dev.duobeiyun.com/paas/collect-event

### 测试本地

wrk -c 250 -t 20 -d 1m -T 5s  -s event.lua  --latency http://localhost:8889/paas/collect-event

wrk -c 250 -t 20 -d 1m -T 5s  -s aes.lua  --latency http://localhost:8889/paas/collect-logan

wrk -c 250 -t 20 -d 1m -T 5s  -s aes-jiami.lua  --latency http://localhost:8889/paas/collect-logan



### 测试线上

wrk -c 250 -t 15 -d 1m -T 5s  -s aes.lua  --latency https://data-center-dev.duobeiyun.com/paas/collect-logan

wrk -c 250 -t 15 -d 1m -T 5s  -s aes-jiami.lua  --latency https://data-center-dev.duobeiyun.com/paas/collect-logan



## 每日任务

### 8月18号

@闫振兴 今天的任务，在昨天做的5s会话成功率的面板上增加以下统计
1. 增加通话列表，显示全部通话，字段与目前列表保持一致
2. 增加平均拉流耗时的统计，统计全局平均、终端平均和PC平均
3. 增加拉流耗时的中位数统计，统计全局中位数、终端中位数和PC中位数



```mongo
{
    "collection": "paas_online_user_sessions",
    "aggregate": [
        {
            "$match": {
                "createdAt": {
                "$gte": {{ start_time }},
                "$lte": {{ end_time }}
            }
            }
        }]
}
```

```json

```



## redash-api

进入会话失败比率：

+ 拉流失败 
  + Terminal
  + PC
+ 超时失败
  + Terminal
  + PC

画一个饼状图

+ Terminal进入会话的次数
+ PC进入绘画的次数



5s进入会话成功率+拉流失败比率+超时失败比率 = 1
5s进入会话成功率+PC端全局失败比率 + Terminal全局失败比率 = 1

PC失败比率 = PC端失败次数 / PC端进入会话次数
PC全局失败比率 = PC失败次数 / 进入会话次数

Terminal失败比率 = Terminal失败次数 / Terminal进入会话次数
Terminal全局失败比率 = Terminal失败次数 / 进入会话次数 

失败次数 = 拉流失败次数 + 超时失败次数 = PC失败次数 + 终端失败次数



求：

+ 终端拉流失败比率
+ PC拉流失败比率
+ 终端超时失败比率
+ PC拉超时失败比率





```json
{
    "总体拉流耗时平均数": 2337.4935064935066,
    "终端拉流耗时平均数": 1848.6153846153845,
    "PC拉流耗时平均数": 4985.583333333333,
    "总体拉流耗时中位数": 2231.0,
    "终端拉流耗时中位数": 2163.0,
    "PC拉流耗时中位数": 4716.0
}


{
    "总体拉流耗时平均数": 4981.88,
    "终端拉流耗时平均数": 4547.8,
    "PC拉流耗时平均数": 5090.4,
    "总体拉流耗时中位数": 4900.0,
    "终端拉流耗时中位数": 3764.0,
    "PC拉流耗时中位数": 4942.0
}
```

[同视-在网用户活跃度明细-日报]()



[同视-在网客户活跃度明细-日报]()



[同视-在网终端APP客户活跃度明细-日报]()



[同视-在网PC APP客户活跃度明细-日报]()



[同视-运营汇总数据-日报]()



[活跃用户版本分布]()



[进入会话5s成功率统计]()



[同视通话严重卡顿率统计]()



[同视终端崩溃数据]()



[PC端用户版本分布]()

