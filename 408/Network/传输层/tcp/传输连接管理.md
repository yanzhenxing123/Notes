# 传输连接管理

## 连接过程：三次握手

### 为什么是三次握手？

我觉得最好的理解就是：

+ 第一次握手，服务器知道了客户端的发送能力

+ 第二次握手，客户端知道了服务器的接受能力和发送能力
+ 第三次握手，服务器知道了 客户端的接受能力

如果两次握手的话，无服务并不知道的客户端的接受能力，如果是四次或更多次的话，未免显得过于繁琐，浪费时间和资源。

**注意**：

* 第一次和第二次是不能携带数据的，因为如果携带数据的话，那么有些攻击会携带大量的数据，进而导致服务器要处理大量的数据并浪费大量的内存。
* 第三次握手是可以携带数据的，因为此时的客户端已经知道服务器的接受和发送能力都是正常的，所以可以进行对其发送数据。



### SYN攻击

SYN就是TCP建立连接时用的一个报文。SYN攻击就是利用软件对服务器进行的欺骗行为。即将自己的源地址进行伪装欺骗，设置为一个不存在的地址，服务器收到第一次握手之后，会发送SYN=1 ACK=1的报文，进而等待客户端的回应，但是这个地址并不存在，所以服务器会一直处于一种半连接状态，造成服务器的拥塞。





## 释放过程：四次挥手

**过程**：

* 第一次挥手，假设是客户端提出的释放连接，那么发送的FIN=1，并进入FIN-WAIT1的状态
* 第二次挥手：服务器收到客户端提出的释放连接之后，发送释放连接的确认，即ACK=1，此时服务器进入CLOSE-WAIT状态，通知上面的应用进程，等待被动关闭。而第二次挥手之后，服务器还是可以发送数据，并且客户端也可以接受数据，因为服务器并没有发送FIN=1这一消息。
* 第三次挥手：服务器将自己的数据完全发送完之后，发送FIN=1， ACK=1的报文段，告诉客户端我以完成数据的传输可以结束通信，并进入LAST-ACK（最后的确认）状态。
* 第四次挥手：客户端收到之后，随即进行确认，并进入TIME-WAIT状态，等待时间为2MSL，服务器收到客户端的确认之后即进入CLOSED状态。



### 为什么是四次挥手？

相比较于三次握手，第二次握手的情况是服务器随机发送了SYN=1+ACK=1的报文，其中ACK是用来应答的，SYN是用来进行同步的。四次挥手中FIN就类似于三次握手中的SYN，而四次挥手过程中，服务接收到客户端的第一次发送的释放报文，并不一定会立即去回应“我也马上关闭”这样的消息，只能告诉客户端“我知道你要关闭了，但是我现在可能还有数据，我得等我老大（应用程序）发送完我再关闭”，然后服务器发送完之后，进行第三次挥手。





### 第四次挥手释放连接时，等待2MSL的意义：

+ 第一就是要保证第四次报文的传输能到达服务器，如果没有到达，服务器会再进行第三次挥手，然后客户端更新等待的时间，继续等待。
+ 第二就是在这个等待的过程中，可以使本连接持续的时间内所产生的所有报文段都从网络中消失，使下一个连接中不会出现这种旧的连接请求。





