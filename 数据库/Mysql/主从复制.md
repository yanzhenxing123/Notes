# 主从复制

## 业务场景

+ 当一个请求进行写、改、删操作时，会进行锁表，所有的读操作都会被阻塞。
+ 数据的热备份
+ 提高性能，减少单个主机的对磁盘的IO操作，达到负载均衡的效果



## 什么是主从复制

数据可以从从一个MySQL数据库服务器主节点复制到一个或多个从节点。MySQL默认采用的是**异步**

复制的方式，从节点不用一直访问主数据库来更新自己的数据。数据的更新在远程连接上进行。

![image-20210611152057013](https://cdn.jsdelivr.net/gh/yanzhenxing123/blogImg@master/typora202106/11/152105-973938.png)

## MySQL复制原理

1. master服务器数据改变，将数据写到binlog中
2. slave服务器在一定的时间间隔中请求主服务器。产看二进制日志是否改变，如果改变，那么将开启一个IO线程请求master服务器的binlog文件
3. 主服务器接受到请求后，会为从服务器的每一个IO线程分配一个dump线程，用于向其发送二进制文件。然后从服务器的IO线程会将二进制文件写到relay-log（中继日志）中。然后从节点将启动SQL 线程从relay-log中读取二进制日志，在本地执行，保证数据的一致性。

**总结:**

+ 从库两个线程：
  + I/O线程 用于请求 和 保存二进制日志到本地的中继日志
  + SQL 线程，读取中继日志，执行sql
+ 主库对应 多个dump线程，用于二进制日志文件的发送。



![image-20210611152111062](https://cdn.jsdelivr.net/gh/yanzhenxing123/blogImg@master/typora202106/11/152111-440595.png)

## MySQL主从同步延时分析

主从复制为单线程的。主库对所有DDL和DML产生的日志写进binlog，由于binlog是顺序写，所以效率很高，slave的sql thread线程将主库的DDL和DML操作事件在slave中重放。DML和DDL的IO操作是随机的，不是顺序，所以成本要高很多，另一方面，由于sql thread也是单线程的，当主库的并发较高时，产生的DML数量超过slave的SQL thread所能处理的速度，或者当slave中有大型query语句产生了锁等待，那么延时就产生了。

**也就是主服务器太快了，从服务器跟不上**

### 解决办法

+ 业务持久化层采用分库操作
+ 一主多从 主写从读
+ 业务层和持久化层之间加 redis和cache层
+ 不同业务的mysql物理上放在不同机器，分散压力。
+ 从服务器使用更好的机器
+ 使用更强劲的设备



